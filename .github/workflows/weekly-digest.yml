name: Weekly Digest Generation

on:
  schedule:
    # Run every Sunday at 6:00 AM UTC (1:00 AM EST)
    - cron: '0 6 * * 0'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run without sending emails'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20.x'

jobs:
  health-check:
    runs-on: ubuntu-latest
    outputs:
      healthy: ${{ steps.check.outputs.healthy }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - uses: actions/cache@v4
        name: Setup pnpm cache
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm build

      - name: Run health checks
        id: check
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          cd apps/runner
          pnpm health-check
          echo "healthy=true" >> $GITHUB_OUTPUT

  generate-content:
    needs: health-check
    if: needs.health-check.outputs.healthy == 'true'
    runs-on: ubuntu-latest
    outputs:
      issue_id: ${{ steps.generate.outputs.issue_id }}
      issue_slug: ${{ steps.generate.outputs.issue_slug }}
      issue_number: ${{ steps.generate.outputs.issue_number }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - uses: actions/cache@v4
        name: Setup pnpm cache
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm build

      - name: Generate weekly digest
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          cd apps/runner
          RESULT=$(pnpm generate-digest 2>&1 | tail -1)
          echo "Result: $RESULT"
          ISSUE_ID=$(echo $RESULT | jq -r '.issueId // empty')
          ISSUE_SLUG=$(echo $RESULT | jq -r '.issueSlug // empty')
          ISSUE_NUMBER=$(echo $RESULT | jq -r '.issueNumber // empty')
          echo "issue_id=$ISSUE_ID" >> $GITHUB_OUTPUT
          echo "issue_slug=$ISSUE_SLUG" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
        timeout-minutes: 15

  send-email:
    needs: generate-content
    if: github.event.inputs.dry_run != 'true' && needs.generate-content.outputs.issue_id != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - uses: actions/cache@v4
        name: Setup pnpm cache
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm build

      - name: Send email digest
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          DIGEST_EMAIL_FROM: ${{ secrets.DIGEST_EMAIL_FROM }}
          SITE_URL: ${{ secrets.SITE_URL }}
        run: |
          cd apps/runner
          pnpm send-email --issue=${{ needs.generate-content.outputs.issue_id }}
        timeout-minutes: 10

  notify:
    needs: [generate-content, send-email]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Report status
        run: |
          echo "Weekly Digest Generation Complete"
          echo "Issue Number: ${{ needs.generate-content.outputs.issue_number }}"
          echo "Issue Slug: ${{ needs.generate-content.outputs.issue_slug }}"
          echo "Email Job Status: ${{ needs.send-email.result }}"
